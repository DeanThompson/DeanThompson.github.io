<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
      <title>Development on 李林克斯 </title>
      <generator uri="https://gohugo.io">Hugo</generator>
    <link>http://deanthompson.github.io/categories/development/</link>
    <language>zh-CN</language>
    <author>Yangliang Li</author>
    
    <updated>Tue, 09 Jun 2015 17:30:20 CST</updated>
    
    <item>
      <title>使用 supervisor 管理进程</title>
      <link>http://deanthompson.github.io/posts/2015/06/using-supervisor</link>
      <pubDate>Tue, 09 Jun 2015 17:30:20 CST</pubDate>
      <author>Yangliang Li</author>
      <guid>http://deanthompson.github.io/posts/2015/06/using-supervisor</guid>
      <description>

&lt;p&gt;Supervisor (&lt;a href=&#34;http://supervisord.org&#34;&gt;http://supervisord.org&lt;/a&gt;) 是一个用 Python 写的进程管理工具，可以很方便的用来启动、重启、关闭进程（不仅仅是 Python 进程）。除了对单个进程的控制，还可以同时启动、关闭多个进程，比如很不幸的服务器出问题导致所有应用程序都被杀死，此时可以用 supervisor 同时启动所有应用程序而不是一个一个地敲命令启动。&lt;/p&gt;

&lt;h2 id=&#34;安装:0374c09b00e8eddcfa304907db4e0a23&#34;&gt;安装&lt;/h2&gt;

&lt;p&gt;Supervisor 可以运行在 Linux、Mac OS X 上。如前所述，supervisor 是 Python 编写的，所以安装起来也很方便，可以直接用 pip :&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo pip install supervisor
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;如果是 Ubuntu 系统，还可以使用 apt-get 安装。&lt;/p&gt;

&lt;h2 id=&#34;supervisord-配置:0374c09b00e8eddcfa304907db4e0a23&#34;&gt;supervisord 配置&lt;/h2&gt;

&lt;p&gt;Supervisor 相当强大，提供了很丰富的功能，不过我们可能只需要用到其中一小部分。安装完成之后，可以编写配置文件，来满足自己的需求。为了方便，我们把配置分成两部分：supervisord（supervisor 是一个 C/S 模型的程序，这是 server 端，对应的有 client 端：supervisorctl）和应用程序（即我们要管理的程序）。&lt;/p&gt;

&lt;p&gt;首先来看 supervisord 的配置文件。安装完 supervisor 之后，可以运行&lt;code&gt;echo_supervisord_conf&lt;/code&gt; 命令输出默认的配置项，也可以重定向到一个配置文件里：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;echo_supervisord_conf &amp;gt; /etc/supervisord.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;去除里面大部分注释和“不相关”的部分，我们可以先看这些配置：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-ini&#34;&gt;[unix_http_server]
file=/tmp/supervisor.sock   ; UNIX socket 文件，supervisorctl 会使用
;chmod=0700                 ; socket 文件的 mode，默认是 0700
;chown=nobody:nogroup       ; socket 文件的 owner，格式： uid:gid

;[inet_http_server]         ; HTTP 服务器，提供 web 管理界面
;port=127.0.0.1:9001        ; Web 管理后台运行的 IP 和端口，如果开放到公网，需要注意安全性
;username=user              ; 登录管理后台的用户名
;password=123               ; 登录管理后台的密码

[supervisord]
logfile=/tmp/supervisord.log ; 日志文件，默认是 $CWD/supervisord.log
logfile_maxbytes=50MB        ; 日志文件大小，超出会 rotate，默认 50MB
logfile_backups=10           ; 日志文件保留备份数量默认 10
loglevel=info                ; 日志级别，默认 info，其它: debug,warn,trace
pidfile=/tmp/supervisord.pid ; pid 文件
nodaemon=false               ; 是否在前台启动，默认是 false，即以 daemon 的方式启动
minfds=1024                  ; 可以打开的文件描述符的最小值，默认 1024
minprocs=200                 ; 可以打开的进程数的最小值，默认 200

; the below section must remain in the config file for RPC
; (supervisorctl/web interface) to work, additional interfaces may be
; added by defining them in separate rpcinterface: sections
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock ; 通过 UNIX socket 连接 supervisord，路径与 unix_http_server 部分的 file 一致
;serverurl=http://127.0.0.1:9001 ; 通过 HTTP 的方式连接 supervisord

; 包含其他的配置文件
[include]
files = relative/directory/*.ini    ; 可以是 *.conf 或 *.ini
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;我们把上面这部分配置保存到 /etc/supervisord.conf（或其他任意有权限访问的文件），然后启动 supervisord（通过 -c 选项指定配置文件路径，如果不指定会按照这个顺序查找配置文件：$CWD/supervisord.conf, $CWD/etc/supervisord.conf, /etc/supervisord.conf）：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;supervisord -c /etc/supervisord.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;查看 supervisord 是否在运行：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;ps aux | grep supervisord
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;program-配置:0374c09b00e8eddcfa304907db4e0a23&#34;&gt;program 配置&lt;/h2&gt;

&lt;p&gt;上面我们已经把 supervisrod 运行起来了，现在可以添加我们要管理的进程的配置文件。可以把所有配置项都写到 supervisord.conf 文件里，但并不推荐这样做，而是通过 include 的方式把不同的程序（组）写到不同的配置文件里。&lt;/p&gt;

&lt;p&gt;为了举例，我们新建一个目录 /etc/supervisor/ 用于存放这些配置文件，相应的，把 /etc/supervisord.conf 里 include 部分的的配置修改一下：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[include]
files = /etc/supervisor/*.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;假设有个用 Python 和 Flask 框架编写的用户中心系统，取名 usercenter，用 gunicorn (&lt;a href=&#34;http://gunicorn.org/&#34;&gt;http://gunicorn.org/&lt;/a&gt;) 做 web 服务器。项目代码位于 &lt;code&gt;/home/leon/projects/usercenter&lt;/code&gt;，gunicorn 配置文件为 &lt;code&gt;gunicorn.py&lt;/code&gt;，WSGI callable 是 wsgi.py 里的 app 属性。所以直接在命令行启动的方式可能是这样的：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cd /home/leon/projects/usercenter
gunicorn -c gunicorn.py wsgi:app
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;现在编写一份配置文件来管理这个进程（&lt;strong&gt;需要注意：用 supervisord 管理时，gunicorn 的 daemon 选项需要设置为 False&lt;/strong&gt;）：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-ini&#34;&gt;[program:usercenter]
directory = /home/leon/projects/usercenter ; 程序的启动目录
command = gunicorn -c gunicorn.py wsgi:app  ; 启动命令，可以看出与手动在命令行启动的命令是一样的
autostart = true     ; 在 supervisord 启动的时候也自动启动
startsecs = 5        ; 启动 5 秒后没有异常退出，就当作已经正常启动了
autorestart = true   ; 程序异常退出后自动重启
startretries = 3     ; 启动失败自动重试次数，默认是 3
user = leon          ; 用哪个用户启动
redirect_stderr = true  ; 把 stderr 重定向到 stdout，默认 false
stdout_logfile_maxbytes = 20MB  ; stdout 日志文件大小，默认 50MB
stdout_logfile_backups = 20     ; stdout 日志文件备份数
; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）
stdout_logfile = /data/logs/usercenter_stdout.log

; 可以通过 environment 来添加需要的环境变量，一种常见的用法是修改 PYTHONPATH
; environment=PYTHONPATH=$PYTHONPATH:/path/to/somewhere
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;一份配置文件至少需要一个 &lt;code&gt;[program:x]&lt;/code&gt; 部分的配置，来告诉 supervisord 需要管理那个进程。&lt;code&gt;[program:x]&lt;/code&gt; 语法中的 &lt;code&gt;x&lt;/code&gt; 表示 program name，会在客户端（supervisorctl 或 web 界面）显示，在 supervisorctl 中通过这个值来对程序进行 start、restart、stop 等操作。&lt;/p&gt;

&lt;h2 id=&#34;使用-supervisorctl:0374c09b00e8eddcfa304907db4e0a23&#34;&gt;使用 supervisorctl&lt;/h2&gt;

&lt;p&gt;Supervisorctl 是 supervisord 的一个命令行客户端工具，启动时需要指定与 supervisord 使用同一份配置文件，否则与 supervisord 一样按照顺序查找配置文件。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;supervisorctl -c /etc/supervisord.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上面这个命令会进入 supervisorctl 的 shell 界面，然后可以执行不同的命令了：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;&amp;gt; status    # 查看程序状态
&amp;gt; stop usercenter   # 关闭 usercenter 程序
&amp;gt; start usercenter  # 启动 usercenter 程序
&amp;gt; restart usercenter    # 重启 usercenter 程序
&amp;gt; reread    ＃ 读取有更新（增加）的配置文件，不会启动新添加的程序
&amp;gt; update    ＃ 重启配置文件修改过的程序
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上面这些命令都有相应的输出，除了进入 supervisorctl 的 shell 界面，也可以直接在 bash 终端运行：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ supervisorctl status
$ supervisorctl stop usercenter
$ supervisorctl start usercenter
$ supervisorctl restart usercenter
$ supervisorctl reread
$ supervisorctl update 
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;其它:0374c09b00e8eddcfa304907db4e0a23&#34;&gt;其它&lt;/h2&gt;

&lt;p&gt;除了 supervisorctl 之外，还可以配置 supervisrod 启动 web 管理界面，这个 web 后台使用 Basic Auth 的方式进行身份认证。&lt;/p&gt;

&lt;p&gt;除了单个进程的控制，还可以配置 group，进行分组管理。&lt;/p&gt;

&lt;p&gt;经常查看日志文件，包括 supervisord 的日志和各个 pragram 的日志文件，程序 crash 或抛出异常的信息一半会输出到 stderr，可以查看相应的日志文件来查找问题。&lt;/p&gt;

&lt;p&gt;Supervisor 有很丰富的功能，还有其他很多项配置，可以在官方文档获取更多信息：&lt;a href=&#34;http://supervisord.org/index.html&#34;&gt;http://supervisord.org/index.html&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
